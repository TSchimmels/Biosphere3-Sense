using System.Text.Json.Serialization;

namespace AttackAgent.Models
{
    /// <summary>
    /// Represents a discovered security vulnerability
    /// </summary>
    public class Vulnerability
    {
        [JsonPropertyName("id")]
        public string Id { get; set; } = Guid.NewGuid().ToString();

        [JsonPropertyName("type")]
        public VulnerabilityType Type { get; set; }

        [JsonPropertyName("severity")]
        public SeverityLevel Severity { get; set; }

        [JsonPropertyName("title")]
        public string Title { get; set; } = string.Empty;

        [JsonPropertyName("description")]
        public string Description { get; set; } = string.Empty;

        [JsonPropertyName("endpoint")]
        public string Endpoint { get; set; } = string.Empty;

        [JsonPropertyName("method")]
        public string Method { get; set; } = string.Empty;

        [JsonPropertyName("parameter")]
        public string? Parameter { get; set; }

        [JsonPropertyName("payload")]
        public string? Payload { get; set; }

        [JsonPropertyName("response")]
        public string? Response { get; set; }

        [JsonPropertyName("evidence")]
        public string Evidence { get; set; } = string.Empty;

        [JsonPropertyName("remediation")]
        public string Remediation { get; set; } = string.Empty;

        [JsonPropertyName("references")]
        public List<string> References { get; set; } = new();

        [JsonPropertyName("discoveredAt")]
        public DateTime DiscoveredAt { get; set; } = DateTime.UtcNow;

        [JsonPropertyName("attackMode")]
        public AttackMode AttackMode { get; set; }

        [JsonPropertyName("confidence")]
        public double Confidence { get; set; } // 0.0 to 1.0

        [JsonPropertyName("falsePositive")]
        public bool FalsePositive { get; set; } = false;

        [JsonPropertyName("verified")]
        public bool Verified { get; set; } = false;
    }

    /// <summary>
    /// Types of security vulnerabilities
    /// </summary>
    public enum VulnerabilityType
    {
        // Injection Attacks
        SqlInjection,
        NoSqlInjection,
        CommandInjection,
        LdapInjection,
        XPathInjection,

        // Cross-Site Scripting
        ReflectedXss,
        StoredXss,
        DomXss,

        // Authentication & Authorization
        AuthenticationBypass,
        PrivilegeEscalation,
        SessionHijacking,
        SessionFixation,
        WeakAuthentication,
        BruteForceVulnerable,

        // Input Validation
        PathTraversal,
        FileUpload,
        UnvalidatedRedirect,
        OpenRedirect,
        InputValidation,

        // Information Disclosure
        InformationDisclosure,
        ErrorInformationDisclosure,
        DirectoryListing,
        BackupFiles,

        // Security Misconfiguration
        InsecureDirectObjectReference,
        MissingSecurityHeaders,
        InsecureCors,
        InsecureCookies,
        WeakEncryption,
        WeakCryptography,
        Cors,
        CorsMisconfiguration,
        Csrf,
        SessionManagement,

        // Business Logic
        RaceCondition,
        TimeOfCheckTimeOfUse,
        InsufficientRateLimiting,
        MissingRateLimiting,
        DenialOfService,
        BusinessLogic,
        Authorization,

        // API Specific
        InsecureApiDesign,
        ExcessiveDataExposure,
        MassAssignment,
        ImproperAssetsManagement,

        // Camera/Sensor Access
        UnauthorizedCameraAccess,
        UnauthorizedMicrophoneAccess,
        UnauthorizedLocationAccess,

        // Custom/Other
        Custom,
        Unknown
    }

    /// <summary>
    /// Severity levels for vulnerabilities
    /// </summary>
    public enum SeverityLevel
    {
        Info,
        Low,
        Medium,
        High,
        Critical
    }

    /// <summary>
    /// Attack mode used to discover the vulnerability
    /// </summary>
    public enum AttackMode
    {
        Stealth,
        Aggressive,
        Both
    }

    /// <summary>
    /// Collection of vulnerabilities found during testing
    /// </summary>
    public class VulnerabilityReport
    {
        [JsonPropertyName("targetUrl")]
        public string TargetUrl { get; set; } = string.Empty;

        [JsonPropertyName("scanStartTime")]
        public DateTime ScanStartTime { get; set; }

        [JsonPropertyName("scanEndTime")]
        public DateTime ScanEndTime { get; set; }

        [JsonPropertyName("totalVulnerabilities")]
        public int TotalVulnerabilities => Vulnerabilities.Count;

        [JsonPropertyName("vulnerabilities")]
        public List<Vulnerability> Vulnerabilities { get; set; } = new();

        [JsonPropertyName("summary")]
        public VulnerabilitySummary Summary { get; set; } = new();

        [JsonPropertyName("riskScore")]
        public double RiskScore { get; set; }

        [JsonPropertyName("overallRiskLevel")]
        public RiskLevel OverallRiskLevel { get; set; }

        [JsonPropertyName("recommendations")]
        public List<string> Recommendations { get; set; } = new();
    }

    /// <summary>
    /// Summary of vulnerabilities by severity and type
    /// </summary>
    public class VulnerabilitySummary
    {
        [JsonPropertyName("criticalCount")]
        public int CriticalCount { get; set; }

        [JsonPropertyName("highCount")]
        public int HighCount { get; set; }

        [JsonPropertyName("mediumCount")]
        public int MediumCount { get; set; }

        [JsonPropertyName("lowCount")]
        public int LowCount { get; set; }

        [JsonPropertyName("infoCount")]
        public int InfoCount { get; set; }

        [JsonPropertyName("vulnerabilityTypes")]
        public Dictionary<VulnerabilityType, int> VulnerabilityTypes { get; set; } = new();

        [JsonPropertyName("endpointsAffected")]
        public int EndpointsAffected { get; set; }

        [JsonPropertyName("falsePositiveCount")]
        public int FalsePositiveCount { get; set; }

        [JsonPropertyName("verifiedCount")]
        public int VerifiedCount { get; set; }
    }
}
