<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Biosphere3 â€” Sensor Monitoring System</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="app-header">
        <div class="brand">
            <div class="brand-mark">B3</div>
            <div class="brand-text">
                <h1>Biosphere3</h1>
                <p class="subtitle">10,000 Sensor Environmental Monitoring System</p>
            </div>
        </div>
        <div class="header-meta">
            <div class="meta-item">
                <span class="meta-label">Status</span>
                <span id="headerStatus" class="meta-value online">Operational</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Region</span>
                <span class="meta-value">Biosphere Campus</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Operator</span>
                <span class="meta-value">Local Admin</span>
            </div>
            <div class="meta-item">
                <span class="meta-label">Last Ingest</span>
                <span id="lastIngest" class="meta-value">--</span>
            </div>
        </div>
    </header>

    <main>
        <section class="dashboard-hero">
            <div class="stat-card">
                <span id="fleetTotalValue" class="stat-number">--</span>
                <span class="stat-label">Sensors Online</span>
                <span class="stat-sub">Fleet total</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">24/7</span>
                <span class="stat-label">Monitoring</span>
                <span class="stat-sub">Live ingestion</span>
            </div>
            <div class="stat-card">
                <span class="stat-number">99.9%</span>
                <span class="stat-label">Uptime</span>
                <span class="stat-sub">Rolling 30 days</span>
            </div>
        </section>

        <section class="alert-banner" id="alertBanner" style="display:none;">
            <span class="alert-icon">!</span>
            <div class="alert-content">
                <strong>Attention required:</strong>
                <span id="alertText">Sensor anomalies detected.</span>
            </div>
            <button id="alertDismiss" class="btn-link">Acknowledge</button>
        </section>

        <section class="kpi-strip">
            <div class="kpi-card">
                <span class="kpi-label">Active Alerts</span>
                <span id="kpiAlerts" class="kpi-value">0</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Offline Sensors</span>
                <span id="kpiOffline" class="kpi-value">0</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Warning Sensors</span>
                <span id="kpiWarning" class="kpi-value">0</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Locations</span>
                <span id="kpiLocations" class="kpi-value">0</span>
            </div>
            <div class="kpi-card">
                <span class="kpi-label">Sensor Types</span>
                <span id="kpiTypes" class="kpi-value">0</span>
            </div>
        </section>

        <section class="control-ribbon">
            <div class="control-group">
                <label for="themeSelect">Theme</label>
                <select id="themeSelect">
                    <option value="ops" selected>Dark Ops</option>
                    <option value="arctic">Arctic</option>
                    <option value="deepsea">Deep Sea</option>
                    <option value="desert">Desert</option>
                </select>
            </div>
            <div class="control-group">
                <label>Mission Control</label>
                <button id="missionToggle" class="btn-secondary">Full Screen</button>
            </div>
            <div class="control-group">
                <label>Demo Mode</label>
                <button id="demoToggle" class="btn-secondary">Start Demo</button>
            </div>
            <div class="control-group">
                <label>Snapshot</label>
                <button id="snapshotBtn" class="btn-secondary">Export PNG</button>
            </div>
            <div class="control-group">
                <label>Onboarding</label>
                <button id="onboardingBtn" class="btn-secondary">Show Guide</button>
            </div>
        </section>

        <section class="viz-grid">
            <div class="viz-panel">
                <div class="viz-header">
                    <h2>3D Biosphere View</h2>
                    <span class="viz-meta">Live positions and clusters</span>
                </div>
                <div class="viz-canvas-wrap">
                    <div id="biosphere3d" class="three-canvas"></div>
                    <div class="blueprint-overlay">Biosphere 2 - Oracle, Arizona</div>
                </div>
                <div class="mini-map-wrap">
                    <div id="miniMapTooltip" class="mini-tooltip" style="display:none;"></div>
                    <canvas id="miniMap" width="220" height="180" class="mini-map"></canvas>
                </div>
            </div>
        </section>

        <section class="story-panel">
            <div class="story-header">
                <h2>Operational Storyline</h2>
                <span class="viz-meta">Auto-generated summary</span>
            </div>
            <div id="storyText" class="story-text">
                The biosphere is stable. Awaiting live updates...
            </div>
            <div id="bootStatus" class="boot-status">JavaScript not running.</div>
            <div id="htmlStamp" class="boot-status">HTML stamp: v20260131b</div>
        </section>

        <section class="chip-panel">
            <div class="story-header">
                <h2>Sensor Chips</h2>
                <span class="viz-meta">Live list with transmit rate</span>
            </div>
            <div id="sensorChips" class="chip-grid"></div>
        </section>

        <section class="hello-section">
            <h2>System Check</h2>
            <p class="section-intro">Run a diagnostic ping across the sensor mesh to confirm connectivity and timing.</p>
            <button id="helloBtn" class="btn-primary">Run Hello World Diagnostic</button>
            <div id="helloResult" class="result-box" style="display:none;"></div>
        </section>

        <section class="data-section">
            <div class="section-header">
                <div>
                    <h2>Sensor Network</h2>
                    <p class="section-intro">Live snapshot of the most recent readings from the SQL sensor table.</p>
                </div>
                <div class="section-actions">
                    <button class="btn-add" onclick="openAddModal()">+ Add Sensor</button>
                </div>
            </div>

            <div class="table-controls">
                <div class="control-group">
                    <label for="searchInput">Search</label>
                    <input id="searchInput" type="text" placeholder="Search name, location, type..." />
                </div>
                <div class="control-group">
                    <label for="statusFilter">Status</label>
                    <select id="statusFilter">
                        <option value="">All</option>
                        <option value="Online">Online</option>
                        <option value="Warning">Warning</option>
                        <option value="Offline">Offline</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="typeFilter">Type</label>
                    <select id="typeFilter">
                        <option value="">All Types</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="sortSelect">Sort</label>
                    <select id="sortSelect">
                        <option value="id">ID</option>
                        <option value="name">Name</option>
                        <option value="status">Status</option>
                        <option value="distance">Distance (0,0,0)</option>
                        <option value="lastUpdated">Last Updated</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="pageSize">Page Size</label>
                    <select id="pageSize">
                        <option value="5">5</option>
                        <option value="10" selected>10</option>
                        <option value="25">25</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="showArchived">Archived</label>
                    <select id="showArchived">
                        <option value="false" selected>Hide Archived</option>
                        <option value="true">Show Archived</option>
                    </select>
                </div>
                <div class="control-group">
                    <label>Export</label>
                    <div class="control-inline">
                        <button id="exportCsv" class="btn-secondary">CSV</button>
                        <button id="exportJson" class="btn-secondary">JSON</button>
                    </div>
                </div>
                <div class="control-group">
                    <label for="importJson">Import JSON</label>
                    <input id="importJson" type="file" accept=".json,application/json" />
                </div>
            </div>

            <div id="sensorTableContainer">
                <p class="placeholder-text">Sensor data will appear here once the database is connected.</p>
            </div>

            <div class="pagination">
                <button id="prevPage" class="btn-secondary">Prev</button>
                <span id="pageInfo" class="page-info">Page 1</span>
                <button id="nextPage" class="btn-secondary">Next</button>
            </div>
            <div id="importStatus" class="import-status"></div>
        </section>

        <section class="chat-section">
            <h2>Biosphere3 Chat</h2>
            <p class="section-intro">Ask the assistant for summaries, alerts, or operational guidance.</p>
            <div id="chatLog" class="chat-log">
                <div class="chat-message system">Assistant online. Ask about the biosphere.</div>
            </div>
            <div class="chat-controls">
                <textarea id="chatInput" rows="3" placeholder="Ask the biosphere assistant..."></textarea>
                <div class="chat-actions">
                    <button id="chatSend" class="btn-primary">Send</button>
                    <span id="chatStatus" class="chat-status" aria-live="polite"></span>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <p>Biosphere3 &mdash; AI Core Full Stack Training Project</p>
        <p class="footer-note">Data displayed is for training purposes only.</p>
    </footer>

    <div id="onboardingOverlay" class="onboarding-overlay" style="display:none;">
        <div class="onboarding-card">
            <h3>Welcome to Biosphere3</h3>
            <ol>
                <li>Use the 3D view to inspect sensor spatial layout.</li>
                <li>Review connectivity status and transmit frequency per sensor.</li>
                <li>Filter the Sensor Network table to isolate issues.</li>
                <li>Use Demo Mode to simulate spikes and failures.</li>
                <li>Export snapshots for presentations.</li>
            </ol>
            <button id="onboardingClose" class="btn-primary">Got it</button>
        </div>
    </div>

    <noscript>
        <div class="boot-status">JavaScript is disabled. Please enable it to load data.</div>
    </noscript>
    <script>
        (function () {
            if (location.search.indexOf('v=') === -1) {
                location.replace(location.pathname + '?v=20260131b');
                return;
            }
            var boot = document.getElementById('bootStatus');
            if (boot) boot.textContent = 'Inline JS running. Loading app.js...';
            setTimeout(function () {
                var current = boot ? boot.textContent : '';
                if (current && current.indexOf('Inline JS') === 0) {
                    if (boot) boot.textContent = 'App JS did not start. Use a modern browser (Edge/Chrome).';
                }
            }, 2000);
        })();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.147.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.147.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <script src="app.legacy.js?v=20260131b"></script>
    <script src="app.js?v=20260131b" onload="document.getElementById('bootStatus').textContent='app.js loaded. Starting...';" onerror="document.getElementById('bootStatus').textContent='app.js failed to load';"></script>
    <script>
        setTimeout(function () {
            var boot = document.getElementById('bootStatus');
            if (!boot) return;
            if (window.BIOSPHERE_APP_READY) {
                boot.textContent = 'App JS running.';
            } else if (boot.textContent.indexOf('app.js loaded') === 0) {
                boot.textContent = 'app.js loaded but failed to run (syntax error).';
            } else if (boot.textContent.indexOf('app.js failed') === 0) {
                // already set by onerror
            } else {
                boot.textContent = 'app.js not executed.';
            }
        }, 1200);
    </script>
    <script>
        setTimeout(function () {
            if (!window.BIOSPHERE_APP_READY) {
                var boot = document.getElementById('bootStatus');
                if (boot) boot.textContent = 'App JS failed to start. Loading legacy mode...';
                var legacy = document.createElement('script');
                legacy.src = 'app.legacy.js';
                legacy.onload = function () {
                    if (boot) boot.textContent = 'Legacy mode active.';
                };
                legacy.onerror = function () {
                    if (boot) boot.textContent = 'Legacy mode failed to load.';
                };
                document.body.appendChild(legacy);
            }
        }, 2000);
    </script>
    <script>
        setTimeout(function () {
            if (window.__FALLBACK_RAN) return;
            window.__FALLBACK_RAN = true;
            var dataReady = window.BIOSPHERE_DATA_READY === true;
            var container = document.getElementById('sensorTableContainer');
            var target = document.getElementById('biosphere3d');
            var tablePresent = container && container.querySelector('table');
            if (dataReady || tablePresent) return;

            if (container) container.innerHTML = '<p class="placeholder-text">Loading sensors (fallback)...</p>';

            fetch('/api/Sensors', { cache: 'no-store' })
                .then(function (r) {
                    if (!r.ok) throw new Error('HTTP ' + r.status);
                    return r.json();
                })
                .then(function (data) {
                    if (container) {
                        if (!data || !data.length) {
                            container.innerHTML = '<p class="placeholder-text">No sensors returned from API.</p>';
                        } else {
                            var rows = data.map(function (s) {
                                return '<tr><td>' + s.id + '</td><td>' + s.name + '</td><td>' + s.location + '</td><td>' + s.type + '</td><td>' + s.lastReading + '</td><td>' + s.unit + '</td><td>' + s.status + '</td></tr>';
                            }).join('');
                            container.innerHTML = '<table><thead><tr><th>ID</th><th>Name</th><th>Location</th><th>Type</th><th>Reading</th><th>Unit</th><th>Status</th></tr></thead><tbody>' + rows + '</tbody></table>';
                        }
                    }

                    if (target) {
                        var canvas = document.createElement('canvas');
                        canvas.width = target.clientWidth || 600;
                        canvas.height = target.clientHeight || 360;
                        target.innerHTML = '';
                        target.appendChild(canvas);
                        var ctx = canvas.getContext('2d');
                        ctx.fillStyle = '#0b0f16';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);

                        ctx.strokeStyle = 'rgba(56, 189, 248, 0.18)';
                        ctx.lineWidth = 1;
                        for (var gx = 0; gx <= canvas.width; gx += 40) {
                            ctx.beginPath();
                            ctx.moveTo(gx, 0);
                            ctx.lineTo(gx, canvas.height);
                            ctx.stroke();
                        }
                        for (var gy = 0; gy <= canvas.height; gy += 40) {
                            ctx.beginPath();
                            ctx.moveTo(0, gy);
                            ctx.lineTo(canvas.width, gy);
                            ctx.stroke();
                        }

                        ctx.strokeStyle = 'rgba(45, 212, 191, 0.55)';
                        ctx.fillStyle = 'rgba(45, 212, 191, 0.12)';
                        ctx.beginPath();
                        ctx.ellipse(canvas.width * 0.28, canvas.height * 0.42, 90, 70, 0, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();

                        ctx.beginPath();
                        ctx.ellipse(canvas.width * 0.62, canvas.height * 0.45, 80, 60, 0, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();

                        ctx.beginPath();
                        ctx.ellipse(canvas.width * 0.72, canvas.height * 0.65, 60, 46, 0, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.stroke();

                        ctx.strokeStyle = 'rgba(56, 189, 248, 0.55)';
                        ctx.fillStyle = 'rgba(15, 23, 42, 0.6)';
                        ctx.fillRect(canvas.width * 0.42, canvas.height * 0.62, 140, 54);
                        ctx.strokeRect(canvas.width * 0.42, canvas.height * 0.62, 140, 54);

                        ctx.fillStyle = 'rgba(14, 165, 233, 0.6)';
                        ctx.beginPath();
                        ctx.arc(canvas.width * 0.46, canvas.height * 0.50, 12, 0, Math.PI * 2);
                        ctx.fill();

                        (data || []).forEach(function (s) {
                            var x = (s.posX % 50) / 50 * canvas.width;
                            var y = (s.posY % 20) / 20 * canvas.height;
                            ctx.fillStyle = s.status === 'Offline' ? '#ef4444' : s.status === 'Warning' ? '#fbbf24' : '#22c55e';
                            ctx.beginPath();
                            ctx.arc(x, y, 4, 0, Math.PI * 2);
                            ctx.fill();
                        });
                    }

                    var boot = document.getElementById('bootStatus');
                    if (boot) boot.textContent = 'Fallback renderer active (data + 2D view).';
                })
                .catch(function (err) {
                    if (container) container.innerHTML = '<p class="placeholder-text">Fallback load failed: ' + err.message + '</p>';
                    var boot = document.getElementById('bootStatus');
                    if (boot) boot.textContent = 'Fallback load failed: ' + err.message;
                });
        }, 3000);
    </script>
</body>
</html>
